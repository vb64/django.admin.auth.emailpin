# Библиотека DjangoAuthEmailPin

[На английском](README.md)

Бесплатная, с открытым исходным кодом библиотека DjangoAuthEmailPin
предназначена для беспарольной авторизации пользователей в админке Django.
Для входа в админку пользователям на емейл высылаются одноразовые коды.

## Установка

```bash
pip install django-admin-auth-emailpin
```

## Использование

Для рассылки кодов авторизации используется штатный способ [рассылки емайл в Django](https://docs.djangoproject.com/en/dev/topics/email/).
Поэтому в файле `settings.py` вашего проекта необходимо указать данные используемого почтового сервера.

```python
# settings.py
EMAIL_HOST = 'smtp.gmail.com'
EMAIL_PORT = 587
EMAIL_USE_TLS = True
```

Таблица пользователя админки Django должна иметь специальные поля для использования библиотеки.

-   `name`: основной адрес email пользователя.
-   `custom_email`: опциональный дополнительный email пользователя.
-   `is_active`: если данное поле установлено в False, то пользователю запрещен вход в админку.

Библиотека предоставляет абстрактный класс `User`, в котором определены эти поля.
Этот класс можно использовать как базовый при определении модели пользователя вашего проекта.

```python
# models.py
from django_admin_auth_emailpin.models import User

class MyUser(User):
    # Заголовки для полей в админке
    title_fld_name = "Основной емейл"
    title_fld_email = "Дополнительный емейл"
    title_fld_active = "Активный"
```

Для использования авторизации пользователей при помощи библиотеки ваш проект должен содержать модель,
унаследованную от класса `PinCode` из библиотеки.

```python
# models.py
from django_admin_auth_emailpin.models import PinCode

class MyUser(User):
    # Заголовки для полей в админке
    title_fld_name = "Основной емейл"
    title_fld_email = "Дополнительный емейл"
    title_fld_active = "Активный"
```

В этой модели необходимо определить следующие методы.

### Метод mail_secrets

Возвращает кортеж из трех элементов, задающих параметры доступа к почтовому серверу.

-   адрес, куда будут высылаться коды авторизации для пользователя `admin` (суперюзера базы данных)
-   имя пользователя для подключения к почтовому серверу
-   пароль для подключения к почтовому серверу

```python
# models.py

    @classmethod
    def mail_secrets(cls):
        return (
          'admin@example.com',
          'example.admin@gmail.com',
          'smtp-password',
        )
```

### Метод mail_inacive

Получает экземпляр модели пользователя, которому запрещен доступ в админку (поле `is_active` установлено в False).

Возвращает кортеж из трех элементов, определяющих параметры емейл, который будет отправлен этому пользователю.

-   адрес, с которого будет отправлен емейл
-   текст темы емейл
-   текст тела емейл

```python
# models.py

    @classmethod
    def mail_inacive(cls, user):
        return (
          "noreply@example.com",
          "Ваш аккаунт на example.com отключен.",
          "Ваш аккаунт {} отключен. Для решеия проблемы обратитесь к админу.".format(user),
        )
```

### Метод mail_login

Получает экземпляр модели пользователя, который запросил авторизацию и экземпляр модели созданного для этого пользователя кода авторизации..

Возвращает кортеж из трех элементов, определяющих параметры емейл с данными для авторизации, который будет отправлен этому пользователю.

-   адрес, с которого будет отправлен емейл
-   текст темы емейл
-   текст тела емейл

```python
# models.py

    @classmethod
    def mail_login(cls, user, pin):
        return (
          "noreply@example.com",
          "Вход на example.com",
          "Для входа как {} используйте код: {}".format(user, pin.code),
        )
```

## Разработка

```
$ git clone git@github.com:vb64/django.admin.auth.emailpin
$ cd django.admin.auth.emailpin
$ make setup PYTHON_BIN=/path/to/python3
$ make tests
```
